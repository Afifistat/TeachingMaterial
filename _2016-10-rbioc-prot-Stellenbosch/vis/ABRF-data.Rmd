# Visualisation use-case: PCA on ABRF

## The ABRF data

Bennett et al. *The 2012/2013 ABRF Proteomic Research Group Study:
Assessing Longitudinal Intralaboratory Variability in Routine Peptide
Liquid Chromatography Tandem Mass Spectrometry*
[Molecular & Cellular Proteomics, 14, 3299-3309](http://www.mcponline.org/content/14/12/3299.short).

> Questions concerning longitudinal data quality and reproducibility
> of proteomic laboratories spurred the Protein Research Group of the
> Association of Biomolecular Resource Facilities (ABRF-PRG) to design
> a study to systematically assess the reproducibility of proteomic
> laboratories over an extended period of time. Developed as an open
> study, initially 64 participants were recruited from the broader
> mass spectrometry community to analyze provided aliquots of a six
> bovine protein tryptic digest mixture every month for a period of
> nine months. Data were uploaded to a central repository, and the
> operators answered an accompanying survey. Ultimately, 45
> laboratories submitted a minimum of eight LC-MSMS raw data files
> collected in data-dependent acquisition (DDA) mode. No standard
> operating procedures were enforced; rather the participants were
> encouraged to analyze the samples according to usual practices in
> the laboratory. Unlike previous studies, this investigation was not
> designed to compare laboratories or instrument configuration, but
> rather to assess the temporal intralaboratory reproducibility. The
> outcome of the study was reassuring with 80% of the participating
> laboratories performing analyses at a medium to high level of
> reproducibility and quality over the 9-month period. For the groups
> that had one or more outlying experiments, the major contributing
> factor that correlated to the survey data was the performance of
> preventative maintenance prior to the LC-MSMS analyses. Thus, the
> Protein Research Group of the Association of Biomolecular Resource
> Facilities recommends that laboratories closely scrutinize the
> quality control data following such events. Additionally, improved
> quality control recording is imperative. This longitudinal study
> provides evidence that mass spectrometry-based proteomics is
> reproducible. When quality control measures are strictly adhered to,
> such reproducibility is comparable among many disparate groups. Data
> from the study are available via ProteomeXchange under the accession
> code PXD002114.

The 46 metrics generated by the 'IDFree' mode of QuaMeter.

```{r, echo = FALSE}
knitr::kable(read.csv("../data/20121213-ABRF-PRF-IDFree-metrics-feature-vars.csv"))
```

## Exercice

```{r, echo = FALSE}
echo. <- TRUE
```

* Locate the data file is `20121213-ABRF-PRF-IDFree-metrics.xlsx` on your disk.

```{r, echo = echo.}
idfile <- "../data/20121213-ABRF-PRF-IDFree-metrics.xlsx"
```

* It is an Excel file. We have seen how to read a text-based
  spreadsheet using `read.csv`, `read.delim`, `read.table`, ...  We
  can also use the `read_excel` function from the `readxl` package to
  read it in. Load the package in your R session.

```{r, echo = echo.}
library("readxl")
```
* In addition to the file name, we also need to provide which sheet to
  read the data from. Check the `read_xl` documentation page and
  identify how to do this.

```{r, eval = FALSE, echo = echo.}
?read_xl
```
* Read the data into R

```{r, echo = echo.}
idfree <- read_excel(idfile, sheet = "ID-free metrics")
```

* What are the dimensions of the data. Check the names of the
  columns. What class is the variable you created with the
  `read_excel` function.

```{r, eval = echo., echo = echo.}
dim(idfree)
colnames(idfree)
class(idfree)
```

## Principal component analysis (PCA)

We can hardly visualise all `r ncol(idfree) - 4` QC metrics to
identify structure or outliers among the data files. A technique that
is often used to visualise high dimensional data is **dimensionality
reduction** or **ordination**, which reduce the number of dimensions
that need to be visualised to make sense of the data. Principle
coordinate analysis will remap the data is such a way that the first
new axis, called first principal component (PC1), explains most of the
variability in the data. The second PC is then chosen to be
perpendicular to PC1 and explain as much variability in the data as
possible. This is repeated until as many PC as there are dimensions
are defined. Only the first few PCs are then used; enough to explain a
certain proportion of variability in the data, or for visualisation,
the 2 or 3 first PCs.

### PCA in R

The `prcomp` function can be used to run a PCA analysis in R. The
input must a `data.frame` or `matrix` of numerics only. Also, it is
advised to *centre* (i.e. shift the data for it to be zero centred)
and *scale* (to have unit variance) the data when doing a PCA, which
can be set with appropriate parameters in the `prcomp` function.

> Apply the `prcomp` function on the centred and scaled `idfree` data.

```{r echo = echo.}
pca <- prcomp(idfree[, -(1:4)], scale = TRUE, center = TRUE)
```

There are two types of plots that can be generated. A scree plot, that
show the variance explained by each PC, and the biplot, that projects
the original data points along the PCs. See examples in the `prcomp`
manual page.

> Produce the scree- and biplot for the QC data.

```{r, echo = echo., eval = echo.}
plot(pca)
biplot(pca)
```

We can also extract the projected data points from the output of
`prcomp` to generate an annotated plot ourselves. These data are
stored in the element names `x`. 

> Extract the PCA data and plot the projection of the MS acquisitions
> along PC1 and PC2, and PC1 and PC3. 

```{r, echo = echo., eval = echo.}
plot(pca$x[, 1:2], col = idfree$Id, cex = 2, pch = 19)
plot(pca$x[, c(1, 3)], col = idfree$Id, cex = 2, pch = 19)
text(pca$x[, 1], pca$x[, 2], rownames(idfree), cex = .7)
```

> **Extra**: added colours representing the acquisitions identifiers
> and add the row indices on the plot (using the `text` function).

```{r, echo = echo., eval = echo.}
library("RColorBrewer")
cls <- c(brewer.pal(12, "Set3"), "steelblue")
cls <- rep(cls, 4)
pch <- rep(c(15, 20), each = 26)
names(cls) <- names(pch) <- unique(idfree$Id)

plot(pca$x[, 1:2], cex = 2, col = cls[as.character(idfree$Id)],
     pch = pch[as.character(idfree$Id)])
text(pca$x[, 1], pca$x[, 2], rownames(idfree), cex = .7)
legend("bottomright", legend = unique(idfree$Id),
       col = cls, pch = pch, ncol = 2, cex = .7, bty = "n")
```
